var console,
    stat,
    map,
    lineSymbol,
    initLat = 38.823,
    initLng = -99.712,
    initZoom = 4;
    markerArray = [],
    lineArray = [],
    tLimit = 10,
    speed = 2;


console = document.getElementById("console-text");
stat = document.getElementById("stat-text");

function addText(box,text) {
    box.value += text;
    //var txt = document.createTextNode(text);
    //box.appendChild(txt);
    stat.scrollTop = stat.scrollHeight; // scoll down when adding text
    // check for commands
    
    
    
}

function myLink(){

    for(i = 0; i < markerArray.length-1; i++){

      var line = new google.maps.Polyline({
        strokeColor: 'yellow',
        strokeOpacity: 0.2,
        path: [markerArray[i].getPosition(), markerArray[markerArray.length - 1].getPosition()],
        //path: [{lat: 22.291, lng: 153.027}, {lat: 18.291, lng: 153.027}],
        icons: [{
          icon: lineSymbol,
          offset: '100%'
        }],
        map: map
      });
            lineArray.push(line);

      animateCircle(line);
    }


 


}

//sat
function initMap() {
  // Create a map object and specify the DOM element for display.
    map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: initLat, lng: initLng},
    //mapTypeId: google.maps.MapTypeId.SATELLITE,
    mapTypeId: google.maps.MapTypeId.HYBRID,

    scrollwheel: false,
    zoom: initZoom
    });
  
    lineSymbol = {
    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
    scale: 2,
    strokeOpacity: 1.0,
    strokeColor: 'purple'
  };
  
    google.maps.event.addListener(map, "rightclick", function(event) {
        var lat = event.latLng.lat();
        var lng = event.latLng.lng();
        // populate yor box/field with lat, lng
        //alert("Lat=" + lat + "; Lng=" + lng);
        if(markerArray.length < tLimit ){
            var n =  "Target"
                c = "red",
                s = 8;
            if(markerArray.length == 0){
            n = "Origin";
            c = "blue";
            s = 12;
            }
            addText(stat,"\n" + n + " " + markerArray.length + " location:\n  Lat: " + lat + "\n  Lng: " + lng + "\n");
            //tArray.push(new Target(lat, lng));
            
            var marker = new google.maps.Marker({
            position: {lat: lat, lng: lng},
            icon: {
            path: google.maps.SymbolPath.CIRCLE,
            strokeColor: c,
            strokeOpacity: 0.5,
            scale: s
            },
            map: map
            });
            markerArray.push(marker);
            myLink();
        }
        else{
        //that's enough targets
        
        }    
    });
    
    geocoder = new google.maps.Geocoder();

    
}



        

// at fixed intervals.
function animateCircle(line) {
    var count = 0;
    window.setInterval(function() {
      count = (count + speed) % 200;

      var icons = line.get('icons');
      icons[0].offset = (count / 2) + '%';
      line.set('icons', icons);
  }, 2);
}


// Deletes all markers in the array by removing references to them.
function clearMarkers() {
    for (var i = 0; i < markerArray.length; i++) {
        markerArray[i].setMap(null);
    }
    for (var i = 0; i < lineArray.length; i++) {
        lineArray[i].setMap(null);
    }
    
    markerArray= [];
}

function goTo(m){
    map.panTo(markerArray[m].position);
    map.setZoom(6);
}


function myCommand(str){
    try {
    var par = str.split(" "),
    num = par.length;
    
    c = par[0];
    if(c == "clear"){
        console.value = "";
    
    }
    else if(c == "map"){
        if(num ==1){
            map.panTo({lat: initLat, lng: initLng});
            map.setZoom(initZoom);
        }
        else if(par[1] == "reset"){
            clearMarkers();
            addText(stat,"\n//====================//\n");
        }
        else{
            goTo(parseInt(par[1], 10));
        }
    
    }
    }
    catch(err) {
       //output error 
    }
    
        //alert( "*" +lastLine+"*");
}

function newlinePress(e, textarea){
    var myKey = (e.keyCode ? e.keyCode : e.which);
    if(myKey == 13) {        
        var content = textarea.value;
        var lastLine = content.substr(content.lastIndexOf("\n")+1);
        //check command
        myCommand(lastLine.trim());
        
    }
 
}






var today = new Date();
var platform = window.navigator.platform;
document.getElementById('plText').innerHTML = platform;
document.getElementById('dtText').innerHTML = today;


//


function my_hide(id){
    document.getElementById(id).style.zIndex = -1;    
}


function my_show(id){
    document.getElementById(id).style.zIndex = 1;

}


var text = document.getElementById('tool-text'),
    binary = document.getElementById('tool-binary'),
    hex = document.getElementById('tool-hex');

function pad(num, size) {
    return ("00000000" + num).substr(-size);
}

text.onkeyup = function(){
    var input = text.value;
    binary.value = "";
    hex.value = "";
    for (i=0; i < input.length; i++) {
        binary.value += pad(input[i].charCodeAt(0).toString(2), 8) + " ";
        hex.value += input[i].charCodeAt(0).toString(16) + " ";
    }
}

// -1 on binary and hex is to remove tailing space

binary.onkeyup = function(){
    var input = binary.value;
    text.value = "";
    hex.value = "";
    
    var all = input.split(" ");
    
     for (i=0; i < all.length-1; i++) {
        var t =  String.fromCharCode(parseInt(all[i], 2))
        text.value += t;
        hex.value += t.charCodeAt(0).toString(16) + " ";
    }
    
}


hex.onkeyup = function(){
    var input = hex.value;
    text.value = "";
    binary.value = "";
    
    var all = input.split(" ");
    
     for (i=0; i < all.length-1; i++) {
        var t =  String.fromCharCode(parseInt(all[i], 16))
        text.value += t;
        binary.value += pad(t.charCodeAt(0).toString(2),8) + " ";
    }
    
}





my_show("modal");
